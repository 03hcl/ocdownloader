/**
 * ownCloud - OCDLR
 *
 * This file is licensed under the Affero General Public License version 3 or
 * later. See the COPYING file.
 *
 * @author Xavier Beurois <www.sgc-univ.net>
 * @copyright Xavier Beurois 2015
 */
OCDLR={},function(){OCDLR.Utils={BaseURL:"/apps/ocdownloader/",BaseID:"#app-content-wrapper ",Queue:"",QueueHeader:"",QueueElt:"",DownloadsFolder:"",TorrentsFolder:"",BadgerStatus:[],ValidURL:function(e){return/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)},PrintError:function(a){$(e.BaseID+"span.muted").removeClass("info alert"),$(e.BaseID+"span.muted").addClass("alert").text(a)},PrintInfo:function(a){$(e.BaseID+"span.muted").removeClass("info alert"),$(e.BaseID+"span.muted").addClass("info").text(a)},UpdateQueue:function(a,t){$(e.QueueElt).length>0&&($(e.BaseID+".loadingtext").show(),$.ajax({url:OC.generateUrl(e.BaseURL+"queue/get"),method:"POST",data:{VIEW:t},dataType:"json",async:!0,cache:!1,timeout:3e4,success:function(d){if(d.ERROR)e.PrintError(d.MESSAGE);else{0!=$(e.QueueElt+'[data-rel="LOADER"]').length&&$(e.QueueElt+'[data-rel="LOADER"]').remove(),$("#ball").Badger(d.COUNTER.ALL),$("#bcompletes").Badger(d.COUNTER.COMPLETES),$("#bactives").Badger(d.COUNTER.ACTIVES),$("#bwaitings").Badger(d.COUNTER.WAITINGS),$("#bstopped").Badger(d.COUNTER.STOPPED),$("#bremoved").Badger(d.COUNTER.REMOVED);var n=[];$.each(d.QUEUE,function(d,l){var o=e.QueueElt+'[data-rel="'+l.GID+'"]';n.push(l.GID),a&&0==$(o).length&&e.PrependToQueue(l,t),"100%"==l.PROGRESSVAL?($(o+' > td[data-rel="FILENAME"]').html('<a href="'+OC.linkTo("files","index.php")+"?dir="+encodeURIComponent(e.DownloadsFolder).replace(/%2F/g,"/")+'">'+l.FILENAME+"</a>"),l.ISTORRENT&&"--"!=l.SPEED?$(o+' > td[data-rel="SPEED"]').html('<div class="icon-upload svg"></div>'+l.SPEED):($(o+' > td[data-rel="SPEED"]').html(l.SPEED),l.ISTORRENT||($(o+' > td[data-rel="ACTION"] > div.icon-pause').remove(),$(o+' > td[data-rel="ACTION"] > div.icon-play').remove()))):$(o+' > td[data-rel="SPEED"]').html("--"!=l.SPEED?'<div class="icon-download svg"></div>'+l.SPEED:l.SPEED),$(o+' > td[data-rel="MESSAGE"] > div.pb-wrap > div.pb-value > div.pb-text').text(l.PROGRESS),$(o+' > td[data-rel="MESSAGE"] > div.pb-wrap > div.pb-value').css("width",l.PROGRESSVAL),$(o+' > td[data-rel="STATUS"]').text(l.STATUS)}),e.RemoveQueueItems(n)}$(e.BaseID+".loadingtext").hide()}}))},RemoveQueueItem:function(a){1==a.parent().children().length&&$(e.Queue+' th[data-rel="ACTION"] > div').remove(),a.remove()},RemoveQueueItems:function(a){$(e.QueueElt).each(function(){-1==a.indexOf($(this).attr("data-rel"))&&$(this).remove()}),0==$(e.QueueElt).length&&$(e.Queue+'> thead th[data-rel="ACTION"] > div').remove()},HideFromQueue:function(a){a.addClass("icon-loading-small"),a.removeClass("icon-close");var d=a.parent().parent(),n=d.attr("data-rel");n?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/hide"),method:"POST",dataType:"json",data:{GID:n},async:!0,cache:!1,timeout:3e4,success:function(t){t.ERROR?(e.PrintError(t.MESSAGE),a.addClass("icon-close"),a.removeClass("icon-loading-small")):(e.PrintInfo(t.MESSAGE+" ("+n+")"),e.RemoveQueueItem(d))}}):e.PrintError(t("ocdownloader","Unable to find the GID for this download ..."))},HideAllFromQueue:function(a){a.addClass("icon-loading-small"),a.removeClass("icon-close");var d=[];$(e.QueueElt+' td[data-rel="ACTION"] > div.icon-close').each(function(){$(this).addClass("icon-loading-small"),$(this).removeClass("icon-close"),d.push($(this).parent().parent().attr("data-rel"))}),d.length>0?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/hideall"),method:"POST",dataType:"json",data:{GIDS:d},async:!0,cache:!1,timeout:3e4,success:function(a){a.ERROR?e.PrintError(a.MESSAGE):(e.PrintInfo(a.MESSAGE),$.each(a.QUEUE,function(a,t){$(e.QueueElt+'[data-rel="'+t.GID+'"]').remove()}),$(e.Queue+' th[data-rel="ACTION"] > div.icon-loading-small').remove())}}):e.PrintError(t("ocdownloader","No downloads in the queue ..."))},PauseDownload:function(a,d){a.addClass("icon-loading-small"),a.removeClass("icon-pause"),$("#bactives").Badger("-1"),$("#bstopped").Badger("+1");var n=a.parent().parent(),l=n.attr("data-rel");l?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/pause"),method:"POST",dataType:"json",data:{GID:l},async:!0,cache:!1,timeout:3e4,success:function(o){o.ERROR?(e.PrintError(o.MESSAGE),a.addClass("icon-pause")):(e.PrintInfo(o.MESSAGE+" ("+l+")"),["add","all"].indexOf(d)>-1?(a.addClass("icon-play"),a.parent().parent().children('td[data-rel="STATUS"]').attr("data-statusid",3),a.parent().parent().children('td[data-rel="STATUS"]').text(t("ocdownloader","Paused")),a.unbind("click"),a.bind("click",function(){e.UnPauseDownload($(this),d)})):e.RemoveQueueItem(n)),a.removeClass("icon-loading-small")}}):e.PrintError(t("ocdownloader","Unable to find the GID for this download ..."))},UnPauseDownload:function(a,d){a.addClass("icon-loading-small"),a.removeClass("icon-play"),$("#bactives").Badger("+1"),$("#bstopped").Badger("-1");var n=a.parent().parent(),l=n.attr("data-rel");l?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/unpause"),method:"POST",dataType:"json",data:{GID:l},async:!0,cache:!1,timeout:3e4,success:function(o){o.ERROR?(e.PrintError(o.MESSAGE),a.addClass("icon-play")):(e.PrintInfo(o.MESSAGE+" ("+l+")"),["add","all"].indexOf(d)>-1?(a.addClass("icon-pause"),a.parent().parent().children('td[data-rel="STATUS"]').attr("data-statusid",1),a.parent().parent().children('td[data-rel="STATUS"]').text(t("ocdownloader","Active")),a.unbind("click"),a.bind("click",function(){e.PauseDownload($(this),d)})):e.RemoveQueueItem(n)),a.removeClass("icon-loading-small")}}):e.PrintError(t("ocdownloader","Unable to find the GID for this download ..."))},RemoveFromQueue:function(a,d,n){a.addClass("icon-loading-small"),a.removeClass("icon-delete");var l=a.parent().parent(),o=l.attr("data-rel");o?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/"+d+"remove"),method:"POST",dataType:"json",data:{GID:o},async:!0,cache:!1,timeout:3e4,success:function(r){if(r.ERROR)e.PrintError(r.MESSAGE),a.addClass("icon-delete"),a.removeClass("icon-loading-small");else if(e.PrintInfo(r.MESSAGE+" ("+o+")"),"all"!=n||d.length>0)e.RemoveQueueItem(l);else if("3"==l.children('td[data-rel="STATUS"]').attr("data-statusid"))$("#bremoved").Badger("-1"),$("#ball").Badger("-1"),e.RemoveFromQueue(a,"completely",n);else{var i=a.parent();i.children("div").remove(),i.parent().children('td[data-rel="STATUS"]').text(t("ocdownloader","Removed")),e.ActionDeleteCompletely(i)}}}):e.PrintError(t("ocdownloader","Unable to find the GID for this download ..."))},RemoveAllFromQueue:function(a,d,n){a.addClass("icon-loading-small"),a.removeClass("icon-delete");var l=[];$(e.QueueElt+' td[data-rel="ACTION"] > div.icon-delete').each(function(){$(this).addClass("icon-loading-small"),$(this).removeClass("icon-delete"),l.push($(this).parent().parent().attr("data-rel"))}),l.length>0?$.ajax({url:OC.generateUrl(e.BaseURL+"queue/"+d+"removeall"),method:"POST",dataType:"json",data:{GIDS:l},async:!0,cache:!1,timeout:3e4,success:function(a){a.ERROR?e.PrintError(a.MESSAGE):(e.PrintInfo(a.MESSAGE),e.RemoveQueueItems(a.GIDS),d.length>0?($("#bremoved").Badger("-"+l.length),$("#ball").Badger("-"+l.length)):($("#bremoved").Badger("+"+l.length),$("#b"+n).Badger("-"+l.length)))}}):e.PrintError(t("ocdownloader","Unable to find the GID for this download ..."))},GetPersonalSetting:function(a){var t="Downloads/Files/Torrents";return $.ajax({url:OC.generateUrl(e.BaseURL+"personalsettings/get"),method:"POST",dataType:"json",data:{KEY:a},async:!1,cache:!1,timeout:3e4,success:function(e){e.ERROR||(t=e.VAL)}}),t},GetTorrentsList:function(a){a.is(":visible")?a.hide():(a.empty(),a.append('<li><p class="loader"><span class="icon-loading-small"></span></p></li>'),a.show(),$.ajax({url:OC.generateUrl(e.BaseURL+"btdownloader/listtorrentfiles"),method:"POST",dataType:"json",async:!0,cache:!1,timeout:3e4,success:function(d){if(d.ERROR)e.PrintError(d.MESSAGE);else if(a.empty(),0==d.FILES.length)a.append("<li><p>"+t("ocdownloader","No Torrent Files")+', <a href="'+OC.linkTo("files","index.php")+"?dir="+encodeURIComponent(e.TorrentsFolder).replace(/%2F/g,"/")+'">'+t("ocdownloader","Upload")+"</a></p></li>");else{for(var n=0;n<d.FILES.length;n++)d.FILES[n].name.match(/\.torrent$/)&&a.append('<li><p class="clickable">'+d.FILES[n].name+"</p></li>");a.children("li").children("p.clickable").bind("click",function(){a.parent().children("a").prop("data-rel","File"),a.parent().children("a").html($(this).text()+'<div class="icon-caret-dark svg"></div>')})}}}))},GetCounters:function(){$.ajax({url:OC.generateUrl(e.BaseURL+"queue/count"),method:"POST",dataType:"json",async:!0,cache:!1,timeout:3e4,success:function(a){a.ERROR?e.PrintError(a.MESSAGE):($("#ball").Badger(a.COUNTER.ALL),$("#bcompletes").Badger(a.COUNTER.COMPLETES),$("#bactives").Badger(a.COUNTER.ACTIVES),$("#bwaitings").Badger(a.COUNTER.WAITINGS),$("#bstopped").Badger(a.COUNTER.STOPPED),$("#bremoved").Badger(a.COUNTER.REMOVED))}})},PrependToQueue:function(a,t){$(e.Queue+"> tbody").prepend('<tr data-rel="'+a.GID+'"><td data-rel="FILENAME" class="padding">'+a.FILENAME+'</td><td data-rel="PROTO" class="border padding">'+a.PROTO+'</td><td data-rel="MESSAGE" class="border"><div class="pb-wrap"><div class="pb-value" style="width: '+a.PROGRESSVAL+';"><div class="pb-text">'+a.PROGRESS+"</div></div></div></td>"+(["add","actives","all"].indexOf(t)>-1?'<td data-rel="SPEED" class="border padding">'+a.SPEED+"</td>":"")+(["add","all"].indexOf(t)>-1?'<td data-rel="STATUS" data-statusid="'+a.STATUSID+'" class="border padding">'+a.STATUS+"</td>":"")+'<td data-rel="ACTION" class="padding"></td></tr>');var d=$(e.QueueElt+'[data-rel="'+a.GID+'"] > td[data-rel="ACTION"]');if(["add"].indexOf(t)>-1){e.ActionHide(d),1==a.STATUSID?e.ActionPause(d,t):3==a.STATUSID&&e.ActionPlay(d,t);var n=e.Queue+'> thead th[data-rel="ACTION"] > div.icon-close';0==$(n).length&&($(e.Queue+'> thead th[data-rel="ACTION"]').append('<div class="icon-close svg"></div>'),$(n).bind("click",function(){e.HideAllFromQueue($(this))}))}if(["completes","waitings","stopped","actives"].indexOf(t)>-1){e.ActionDelete(d,e.BadgerStatus[a.STATUSID],t);var l=e.Queue+'> thead th[data-rel="ACTION"] > div.icon-delete';0==$(l).length&&($(e.Queue+'> thead th[data-rel="ACTION"]').append('<div class="icon-delete svg"></div>'),$(l).bind("click",function(){e.RemoveAllFromQueue($(this),"",t)}))}if("all"==t&&(4==a.STATUSID?e.ActionDeleteCompletely(d):(e.ActionDelete(d,e.BadgerStatus[a.STATUSID],t),1==a.STATUSID?e.ActionPause(d,t):3==a.STATUSID&&e.ActionPlay(d,t))),"actives"==t&&e.ActionPause(d,t),"stopped"==t&&e.ActionPlay(d,t),"removed"==t){e.ActionDeleteCompletely(d);var o=e.Queue+'> thead th[data-rel="ACTION"] > div.icon-delete';0==$(o).length&&($(e.Queue+'> thead th[data-rel="ACTION"]').append('<div class="icon-delete svg"></div>'),$(o).bind("click",function(){e.RemoveAllFromQueue($(this),"completely",t)}))}},AddDownload:function(a,t,d,n){var l=!1;return a.hasClass("icon-loading-small")||(a.children("a").css("display","none"),a.addClass("icon-loading-small"),$.ajax({url:OC.generateUrl(e.BaseURL+t+"downloader/add"),method:"POST",dataType:"json",data:{FILE:d,OPTIONS:n},async:!0,cache:!1,timeout:3e4,success:function(t){t.ERROR?e.PrintError(t.MESSAGE):(e.PrintInfo(t.MESSAGE+" ("+t.GID+")"),e.PrependToQueue(t,"add"),$("#ball").Badger("+1"),1==t.STATUSID&&$("#bactives").Badger("+1"),3==t.STATUSID&&$("#bwaitings").Badger("+1"),l=!0),a.children("a").css("display","block"),a.removeClass("icon-loading-small")}})),l},ActionHide:function(a){a.append('<div class="icon-close svg"></div>'),a.children("div.icon-close").bind("click",function(){e.HideFromQueue($(this))})},ActionPause:function(a,t){a.append('<div class="icon-pause svg"></div>'),a.children("div.icon-pause").bind("click",function(){e.PauseDownload($(this),t)})},ActionPlay:function(a,t){a.append('<div class="icon-play svg"></div>'),a.children("div.icon-play").bind("click",function(){e.UnPauseDownload($(this),t)})},ActionDelete:function(a,t,d){a.append('<div class="icon-delete svg"></div>'),a.children("div.icon-delete").bind("click",function(){$("#bremoved").Badger("+1"),$("#b"+t).Badger("-1"),e.RemoveFromQueue($(this),"",d)})},ActionDeleteCompletely:function(a){a.append('<div class="icon-delete svg"></div>'),a.children("div.icon-delete").bind("click",function(){$("#bremoved").Badger("-1"),$("#ball").Badger("-1"),e.RemoveFromQueue($(this),"completely","removed")})}};var e=OCDLR.Utils;e.DownloadsFolder=e.GetPersonalSetting("DownloadsFolder"),e.TorrentsFolder=e.GetPersonalSetting("TorrentsFolder"),e.Queue=e.BaseID+"#Queue ",e.QueueHeader=e.Queue+"thead tr",e.QueueElt=e.Queue+"tbody tr",e.BadgerStatus=["completes","actives","waitings","stopped"]}();